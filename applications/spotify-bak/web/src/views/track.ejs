<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= track.name || 'Unknown Track' %> - Spotify Sync PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <% if (audioFeatures) { %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <% } %>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-green-600 text-white p-4 shadow-lg">
    <div class="container mx-auto flex flex-wrap items-center justify-between gap-4">
      <a href="/" class="text-2xl font-bold hover:underline">ðŸŽµ Spotify Sync PRO</a>
      <div class="flex flex-wrap items-center gap-4 text-sm">
        <a href="/search" class="hover:underline">Search</a>
        <a href="/playlists" class="hover:underline">Playlists</a>
        <a href="/tracks" class="hover:underline font-semibold">Tracks</a>
        <a href="/artists" class="hover:underline">Artists</a>
        <a href="/genres" class="hover:underline">Genres</a>
        <a href="/auth/logout" class="bg-white text-green-600 px-3 py-1.5 rounded hover:bg-gray-100 transition">
          Logout
        </a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-8">
    <!-- Track Hero Section -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Album Art -->
        <div class="flex-shrink-0">
          <% if (track.album_image) { %>
            <img src="<%= track.album_image %>" alt="<%= track.name %>" class="w-64 h-64 object-cover rounded-lg shadow-lg">
          <% } else { %>
            <%
              const palette = ['bg-emerald-200 text-emerald-900','bg-amber-200 text-amber-900','bg-sky-200 text-sky-900','bg-rose-200 text-rose-900','bg-indigo-200 text-indigo-900','bg-lime-200 text-lime-900'];
              const base = track.album_name || track.name || 'Track';
              const initials = base.split(' ').filter(Boolean).slice(0, 2).map(word => word[0]).join('').toUpperCase();
              const color = palette[(base.charCodeAt(0) || 0) % palette.length];
            %>
            <div class="w-64 h-64 rounded-lg flex items-center justify-center text-6xl font-semibold <%= color %>">
              <%= initials || 'TR' %>
            </div>
          <% } %>
        </div>

        <!-- Track Info -->
        <div class="flex-1">
          <h1 class="text-4xl font-bold text-gray-800 mb-2"><%= track.name || 'Unknown Track' %></h1>

          <!-- Artists -->
          <% if (artists && artists.length > 0) { %>
            <p class="text-xl text-gray-600 mb-4">
              <% artists.forEach(function(artist, index) { %>
                <%
                  const artistLabel = artist.name || 'Unknown Artist';
                %>
                <a href="/artist/<%= artist.id %>" class="text-blue-600 hover:underline"><%= artistLabel %></a><% if (index < artists.length - 1) { %>, <% } %>
              <% }); %>
            </p>
          <% } else { %>
            <p class="text-xl text-gray-600 mb-4">Unknown Artist</p>
          <% } %>

          <!-- Album Info -->
          <% if (track.album_name || track.album_id) { %>
            <p class="text-gray-600 mb-4">
              <span class="font-semibold">Album:</span>
              <%
                const albumLabel = track.album_name || 'Unknown Album';
              %>
              <% if (track.album_id) { %>
                <a href="/album/<%= track.album_id %>" class="text-blue-600 hover:underline"><%= albumLabel %></a>
              <% } else { %>
                <%= albumLabel %>
              <% } %>
              <% if (track.album_external_url) { %>
                <a href="<%= track.album_external_url %>" target="_blank" rel="noopener" class="ml-2 text-xs text-green-700 hover:text-green-800">â†—</a>
              <% } %>
              <% if (track.album_release_date && track.album_release_date !== '0000') { %>
                <span class="text-sm text-gray-500">Â· <%= track.album_release_date %></span>
              <% } %>
            </p>
          <% } %>

          <!-- Track Details Grid -->
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6">
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">DURATION</p>
              <%
                const minutes = Math.floor(track.duration_ms / 60000);
                const seconds = Math.floor((track.duration_ms % 60000) / 1000);
              %>
              <p class="text-lg font-bold text-gray-800"><%= minutes %>:<%= seconds.toString().padStart(2, '0') %></p>
            </div>

            <% if (track.popularity !== null && track.popularity !== undefined) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">POPULARITY</p>
                <p class="text-lg font-bold text-gray-800"><%= track.popularity %>%</p>
              </div>
            <% } %>

            <% if (track.explicit !== null && track.explicit !== undefined) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">EXPLICIT</p>
                <p class="text-lg font-bold text-gray-800"><%= track.explicit ? 'Yes' : 'No' %></p>
              </div>
            <% } %>

            <% if (track.track_number) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">TRACK #</p>
                <p class="text-lg font-bold text-gray-800"><%= track.track_number %><% if (track.disc_number) { %> (Disc <%= track.disc_number %>)<% } %></p>
              </div>
            <% } %>

            <% if (track.isrc) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">ISRC</p>
                <p class="text-sm font-mono text-gray-800"><%= track.isrc %></p>
              </div>
            <% } %>

            <% if (track.is_playable !== null && track.is_playable !== undefined) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">PLAYABLE</p>
                <p class="text-lg font-bold text-gray-800"><%= track.is_playable ? 'Yes' : 'No' %></p>
              </div>
            <% } %>

            <% if (track.is_local) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">LOCAL TRACK</p>
                <p class="text-lg font-bold text-gray-800">Yes</p>
              </div>
            <% } %>
          </div>

          <div class="mt-4">
            <% if (track.external_url) { %>
              <a href="<%= track.external_url %>" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-green-700 hover:text-green-800 font-semibold">
                â†—
              </a>
              <span class="text-gray-300 mx-2">â€¢</span>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Features Section -->
    <% if (audioFeatures) { %>
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Audio Features</h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Radar Chart -->
          <div>
            <canvas id="audioFeaturesChart" class="max-w-full"></canvas>
          </div>

          <!-- Key Metrics -->
          <div class="space-y-4">
            <% if (audioFeatures.tempo) { %>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600 mb-2">TEMPO</p>
                <p class="text-3xl font-bold text-gray-800"><%= Math.round(audioFeatures.tempo) %> BPM</p>
              </div>
            <% } %>

            <% if (audioFeatures.key !== null && audioFeatures.key !== undefined) { %>
              <%
                const keyMap = ['C', 'Câ™¯/Dâ™­', 'D', 'Dâ™¯/Eâ™­', 'E', 'F', 'Fâ™¯/Gâ™­', 'G', 'Gâ™¯/Aâ™­', 'A', 'Aâ™¯/Bâ™­', 'B'];
                const mode = audioFeatures.mode === 1 ? 'Major' : 'Minor';
                const keyName = `${keyMap[audioFeatures.key]} ${mode}`;
              %>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600 mb-2">KEY</p>
                <p class="text-3xl font-bold text-gray-800"><%= keyName %></p>
              </div>
            <% } %>

            <div class="grid grid-cols-2 gap-4">
              <% if (audioFeatures.energy !== null && audioFeatures.energy !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">ENERGY</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.energy * 100) %>%</p>
                </div>
              <% } %>

              <% if (audioFeatures.danceability !== null && audioFeatures.danceability !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">DANCEABILITY</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.danceability * 100) %>%</p>
                </div>
              <% } %>

              <% if (audioFeatures.valence !== null && audioFeatures.valence !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">VALENCE</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.valence * 100) %>%</p>
                  <p class="text-xs text-gray-500 mt-1"><%= audioFeatures.valence > 0.5 ? 'ðŸ˜Š Happy' : 'ðŸ˜¢ Sad' %></p>
                </div>
              <% } %>

              <% if (audioFeatures.acousticness !== null && audioFeatures.acousticness !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">ACOUSTIC</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.acousticness * 100) %>%</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <script>
        const ctx = document.getElementById('audioFeaturesChart');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Energy', 'Danceability', 'Valence', 'Acousticness', 'Instrumentalness', 'Liveness'],
            datasets: [{
              label: 'Audio Features',
              data: [
                <%= audioFeatures.energy * 100 %>,
                <%= audioFeatures.danceability * 100 %>,
                <%= audioFeatures.valence * 100 %>,
                <%= audioFeatures.acousticness * 100 %>,
                <%= audioFeatures.instrumentalness * 100 %>,
                <%= audioFeatures.liveness * 100 %>
              ],
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgb(34, 197, 94)',
              borderWidth: 2,
              pointBackgroundColor: 'rgb(34, 197, 94)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(34, 197, 94)'
            }]
          },
          options: {
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      </script>
    <% } else { %>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
        <p class="text-yellow-800 text-center">
          <span class="text-2xl mb-2 block">ðŸ“Š</span>
          Audio features not available for this track
        </p>
      </div>
    <% } %>

    <!-- Artists Section -->
    <% if (artists && artists.length > 0) { %>
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Artists</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% artists.forEach(function(artist) { %>
            <a href="/artist/<%= artist.id %>" class="block border border-gray-200 rounded-lg p-4 hover:bg-gray-50 hover:shadow-md transition">
              <% if (artist.image_url) { %>
                <img src="<%= artist.image_url %>" alt="<%= artist.name %>" class="w-full h-32 object-cover rounded-full mb-3 mx-auto">
              <% } else { %>
                <%
                  const palette = ['bg-emerald-200 text-emerald-900','bg-amber-200 text-amber-900','bg-sky-200 text-sky-900','bg-rose-200 text-rose-900','bg-indigo-200 text-indigo-900','bg-lime-200 text-lime-900'];
                  const base = artist.name || 'Artist';
                  const initials = base.split(' ').filter(Boolean).slice(0, 2).map(word => word[0]).join('').toUpperCase();
                  const color = palette[(base.charCodeAt(0) || 0) % palette.length];
                %>
                <div class="w-32 h-32 rounded-full mb-3 flex items-center justify-center text-3xl font-semibold <%= color %> mx-auto">
                  <%= initials || 'AR' %>
                </div>
              <% } %>
              <h3 class="font-semibold text-gray-800 text-center text-lg"><%= artist.name %></h3>

              <% if (artist.genres) { %>
                <%
                  const genres = typeof artist.genres === 'string' ? JSON.parse(artist.genres) : artist.genres;
                %>
                <% if (genres && genres.length > 0) { %>
                  <div class="flex flex-wrap gap-1 mt-2 justify-center">
                    <% genres.slice(0, 3).forEach(function(genre) { %>
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded"><%= genre %></span>
                    <% }); %>
                  </div>
                <% } %>
              <% } %>

              <% if (artist.popularity !== null && artist.popularity !== undefined) { %>
                <div class="mt-3">
                  <div class="flex items-center gap-2">
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                      <div class="bg-green-600 h-2 rounded-full" style="width: <%= artist.popularity %>%"></div>
                    </div>
                    <span class="text-xs text-gray-600"><%= artist.popularity %>%</span>
                  </div>
                </div>
              <% } %>
            </a>
          <% }); %>
        </div>
      </div>
    <% } %>
  </main>

  <footer class="text-center text-gray-500 text-sm p-4 mt-8">
    <p>Spotify Sync PRO | <a href="/" class="text-blue-500 hover:underline">Dashboard</a></p>
  </footer>
</body>
</html>
