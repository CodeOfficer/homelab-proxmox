# Spotify SQLite Backup CronJob - daily to UNAS K3sStorage
# Backs up spotify.db (playlists, tracks, OAuth credentials) for disaster recovery
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: spotify-backup
  namespace: spotify
spec:
  schedule: "0 5 * * *"  # 5 AM daily (after Open-WebUI at 4 AM)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          nodeSelector:
            node-role.kubernetes.io/control-plane: "true"
          tolerations:
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"
          containers:
          - name: backup
            image: alpine:latest
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e
                apk add --no-cache curl sqlite >/dev/null 2>&1

                DEST_DIR="/dest/spotify/backups"
                HISTORY_DIR="$DEST_DIR/history"
                mkdir -p "$DEST_DIR" "$HISTORY_DIR"

                SOURCE_DB="/data/spotify.db"

                if [ ! -f "$SOURCE_DB" ]; then
                  echo "ERROR: spotify.db not found at $SOURCE_DB"
                  exit 1
                fi

                echo "Starting Spotify backup at $(date)"

                # Checksum-based gating
                CHECKSUM_FILE="$DEST_DIR/.last-backup-checksum"
                CURRENT_CHECKSUM=$(md5sum "$SOURCE_DB" | cut -d' ' -f1)
                LAST_CHECKSUM=$(cat "$CHECKSUM_FILE" 2>/dev/null || echo "none")

                if [ "$CURRENT_CHECKSUM" = "$LAST_CHECKSUM" ]; then
                  echo "No changes detected - skipping"
                  if [ -n "${TELEGRAM_BOT_TOKEN:-}" ]; then
                    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                      -d chat_id="${TELEGRAM_CHAT_ID}" \
                      -d text="⏭️ Spotify backup skipped (no changes)" >/dev/null || true
                  fi
                  exit 0
                fi

                # Create backup using SQLite .backup
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                BACKUP_FILE="${HISTORY_DIR}/spotify_${TIMESTAMP}.db"

                echo "Creating backup: ${BACKUP_FILE}"
                sqlite3 "$SOURCE_DB" ".backup '${BACKUP_FILE}'"

                echo "$CURRENT_CHECKSUM" > "$CHECKSUM_FILE"
                cp "${BACKUP_FILE}" "${DEST_DIR}/latest.db"

                # Keep last 7 backups
                cd "$HISTORY_DIR"
                ls -t spotify_*.db 2>/dev/null | tail -n +8 | xargs rm -f 2>/dev/null || true

                BACKUP_SIZE=$(du -sh "${DEST_DIR}/latest.db" | cut -f1)
                BACKUP_COUNT=$(ls -1 "$HISTORY_DIR"/spotify_*.db 2>/dev/null | wc -l | tr -d ' ')

                echo "Backup complete at $(date)"

                if [ -n "${TELEGRAM_BOT_TOKEN:-}" ]; then
                  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                    -d chat_id="${TELEGRAM_CHAT_ID}" \
                    -d text="✅ Spotify backup complete%0ASize: ${BACKUP_SIZE}%0ABackups: ${BACKUP_COUNT}/7" >/dev/null || true
                fi
            env:
              - name: TELEGRAM_BOT_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: telegram-credentials
                    key: bot-token
                    optional: true
              - name: TELEGRAM_CHAT_ID
                valueFrom:
                  secretKeyRef:
                    name: telegram-credentials
                    key: chat-id
                    optional: true
            volumeMounts:
              - name: data
                mountPath: /data
                readOnly: true
              - name: dest
                mountPath: /dest
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: spotify-data
            - name: dest
              hostPath:
                path: /mnt/k3s-nfs
                type: Directory
          restartPolicy: OnFailure
