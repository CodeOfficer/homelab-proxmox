<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= track.name %> - Spotify Sync PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <% if (audioFeatures) { %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <% } %>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-green-600 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <a href="/" class="text-2xl font-bold hover:underline">üéµ Spotify Sync PRO</a>
      <div class="flex gap-4 items-center">
        <a href="/search" class="hover:underline">Search</a>
        <a href="/playlists" class="hover:underline">All Playlists</a>
        <a href="/auth/logout" class="bg-white text-green-600 px-4 py-2 rounded hover:bg-gray-100 transition">
          Logout
        </a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-8">
    <!-- Track Hero Section -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Album Art -->
        <div class="flex-shrink-0">
          <% if (track.album_image) { %>
            <img src="<%= track.album_image %>" alt="<%= track.name %>" class="w-64 h-64 object-cover rounded-lg shadow-lg">
          <% } else { %>
            <div class="w-64 h-64 bg-gray-300 rounded-lg flex items-center justify-center text-gray-500 text-6xl">
              üéµ
            </div>
          <% } %>
        </div>

        <!-- Track Info -->
        <div class="flex-1">
          <h1 class="text-4xl font-bold text-gray-800 mb-2"><%= track.name %></h1>

          <!-- Artists -->
          <% if (artists && artists.length > 0) { %>
            <p class="text-xl text-gray-600 mb-4">
              <% artists.forEach(function(artist, index) { %>
                <a href="/artist/<%= artist.id %>" class="text-blue-600 hover:underline"><%= artist.name %></a><% if (index < artists.length - 1) { %>, <% } %>
              <% }); %>
            </p>
          <% } else { %>
            <p class="text-xl text-gray-600 mb-4">Unknown Artist</p>
          <% } %>

          <!-- Album Info -->
          <% if (track.album_name) { %>
            <p class="text-gray-600 mb-4">
              <span class="font-semibold">Album:</span> <%= track.album_name %>
            </p>
          <% } %>

          <!-- Track Details Grid -->
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6">
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">DURATION</p>
              <%
                const minutes = Math.floor(track.duration_ms / 60000);
                const seconds = Math.floor((track.duration_ms % 60000) / 1000);
              %>
              <p class="text-lg font-bold text-gray-800"><%= minutes %>:<%= seconds.toString().padStart(2, '0') %></p>
            </div>

            <% if (track.popularity !== null && track.popularity !== undefined) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">POPULARITY</p>
                <p class="text-lg font-bold text-gray-800"><%= track.popularity %>%</p>
              </div>
            <% } %>

            <% if (track.explicit !== null && track.explicit !== undefined) { %>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">EXPLICIT</p>
                <p class="text-lg font-bold text-gray-800"><%= track.explicit ? 'Yes' : 'No' %></p>
              </div>
            <% } %>
          </div>

          <div class="mt-4">
            <button onclick="history.back()" class="text-blue-600 hover:underline">‚Üê Back</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Features Section -->
    <% if (audioFeatures) { %>
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Audio Features</h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Radar Chart -->
          <div>
            <canvas id="audioFeaturesChart" class="max-w-full"></canvas>
          </div>

          <!-- Key Metrics -->
          <div class="space-y-4">
            <% if (audioFeatures.tempo) { %>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600 mb-2">TEMPO</p>
                <p class="text-3xl font-bold text-gray-800"><%= Math.round(audioFeatures.tempo) %> BPM</p>
              </div>
            <% } %>

            <% if (audioFeatures.key !== null && audioFeatures.key !== undefined) { %>
              <%
                const keyMap = ['C', 'C‚ôØ/D‚ô≠', 'D', 'D‚ôØ/E‚ô≠', 'E', 'F', 'F‚ôØ/G‚ô≠', 'G', 'G‚ôØ/A‚ô≠', 'A', 'A‚ôØ/B‚ô≠', 'B'];
                const mode = audioFeatures.mode === 1 ? 'Major' : 'Minor';
                const keyName = `${keyMap[audioFeatures.key]} ${mode}`;
              %>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600 mb-2">KEY</p>
                <p class="text-3xl font-bold text-gray-800"><%= keyName %></p>
              </div>
            <% } %>

            <div class="grid grid-cols-2 gap-4">
              <% if (audioFeatures.energy !== null && audioFeatures.energy !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">ENERGY</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.energy * 100) %>%</p>
                </div>
              <% } %>

              <% if (audioFeatures.danceability !== null && audioFeatures.danceability !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">DANCEABILITY</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.danceability * 100) %>%</p>
                </div>
              <% } %>

              <% if (audioFeatures.valence !== null && audioFeatures.valence !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">VALENCE</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.valence * 100) %>%</p>
                  <p class="text-xs text-gray-500 mt-1"><%= audioFeatures.valence > 0.5 ? 'üòä Happy' : 'üò¢ Sad' %></p>
                </div>
              <% } %>

              <% if (audioFeatures.acousticness !== null && audioFeatures.acousticness !== undefined) { %>
                <div class="bg-gray-50 p-4 rounded-lg">
                  <p class="text-xs font-semibold text-gray-600 mb-1">ACOUSTIC</p>
                  <p class="text-xl font-bold text-gray-800"><%= Math.round(audioFeatures.acousticness * 100) %>%</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <script>
        const ctx = document.getElementById('audioFeaturesChart');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Energy', 'Danceability', 'Valence', 'Acousticness', 'Instrumentalness', 'Liveness'],
            datasets: [{
              label: 'Audio Features',
              data: [
                <%= audioFeatures.energy * 100 %>,
                <%= audioFeatures.danceability * 100 %>,
                <%= audioFeatures.valence * 100 %>,
                <%= audioFeatures.acousticness * 100 %>,
                <%= audioFeatures.instrumentalness * 100 %>,
                <%= audioFeatures.liveness * 100 %>
              ],
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgb(34, 197, 94)',
              borderWidth: 2,
              pointBackgroundColor: 'rgb(34, 197, 94)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(34, 197, 94)'
            }]
          },
          options: {
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      </script>
    <% } else { %>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
        <p class="text-yellow-800 text-center">
          <span class="text-2xl mb-2 block">üìä</span>
          Audio features not available for this track
        </p>
      </div>
    <% } %>

    <!-- Artists Section -->
    <% if (artists && artists.length > 0) { %>
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Artists</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% artists.forEach(function(artist) { %>
            <a href="/artist/<%= artist.id %>" class="block border border-gray-200 rounded-lg p-4 hover:bg-gray-50 hover:shadow-md transition">
              <% if (artist.image_url) { %>
                <img src="<%= artist.image_url %>" alt="<%= artist.name %>" class="w-full h-32 object-cover rounded-full mb-3 mx-auto">
              <% } else { %>
                <div class="w-32 h-32 bg-gray-300 rounded-full mb-3 flex items-center justify-center text-gray-500 text-3xl mx-auto">
                  üé§
                </div>
              <% } %>
              <h3 class="font-semibold text-gray-800 text-center text-lg"><%= artist.name %></h3>

              <% if (artist.genres) { %>
                <%
                  const genres = typeof artist.genres === 'string' ? JSON.parse(artist.genres) : artist.genres;
                %>
                <% if (genres && genres.length > 0) { %>
                  <div class="flex flex-wrap gap-1 mt-2 justify-center">
                    <% genres.slice(0, 3).forEach(function(genre) { %>
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded"><%= genre %></span>
                    <% }); %>
                  </div>
                <% } %>
              <% } %>

              <% if (artist.popularity !== null && artist.popularity !== undefined) { %>
                <div class="mt-3">
                  <div class="flex items-center gap-2">
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                      <div class="bg-green-600 h-2 rounded-full" style="width: <%= artist.popularity %>%"></div>
                    </div>
                    <span class="text-xs text-gray-600"><%= artist.popularity %>%</span>
                  </div>
                </div>
              <% } %>
            </a>
          <% }); %>
        </div>
      </div>
    <% } %>
  </main>

  <footer class="text-center text-gray-500 text-sm p-4 mt-8">
    <p>Spotify Sync PRO | <a href="/" class="text-blue-500 hover:underline">Dashboard</a></p>
  </footer>
</body>
</html>
