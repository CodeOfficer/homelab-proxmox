# thelande/7dtd Helm chart values for homelab
# Chart: https://github.com/thelande/7dtd
# Chart version: 0.5.3, App version: 0.4.7

image:
  repository: thelande/7dtd
  tag: "0.4.7"
  pullPolicy: IfNotPresent

# Node scheduling - control plane only (not GPU node)
nodeSelector:
  node-role.kubernetes.io/control-plane: "true"

tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# Pod security
podSecurityContext:
  fsGroup: 1000

# Storage - local-path for performance (game is disk-intensive)
persistentStorage:
  enabled: true
  gameFiles:
    storageClass: local-path
    size: 30Gi
  steam:
    storageClass: local-path
    size: 1Gi
  backups:
    storageClass: local-path
    size: 20Gi

# Services - LoadBalancer for external access via MetalLB
gameService:
  type: LoadBalancer
  port: 26900

webDashboardService:
  type: ClusterIP  # Access via port-forward
  port: 8080

telnetService:
  type: ClusterIP  # Internal only for auto-save CronJob
  port: 8081

# Health probes - long startup for initial download (~12GB) + world generation
startupDelaySeconds: 2700  # 45 minutes

livenessProbe:
  tcpSocket:
    port: 26900
  periodSeconds: 60
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: 26900
  periodSeconds: 60
  failureThreshold: 2

# Resources
resources:
  requests:
    memory: "4Gi"
    cpu: "2"
  limits:
    memory: "8Gi"
    cpu: "4"

# Server identification
serverName: "Homelab 7DTD"
serverDescription: "Private Homelab Server"
serverWebsiteURL: ""
serverPassword: ""
serverPort: 26900
serverMaxPlayerCount: 8
serverVisibility: 1

# World & Gameplay - nested structure per upstream chart
serverConfig:
  other:
    eacEnabled: false
  gameplay:
    world:
      gameWorld: "RWG"
      gameName: "FoundationRWG"
      worldGenSeed: "foundation"
      worldGenSize: 8192
    difficulty:
      gameDifficulty: 3
    misc:
      dropOnDeath: 0
      dropOnQuit: 0
      dayNightLength: 60
      bloodMoonFrequency: 7
    loot:
      lootAbundance: 100
    spawning:
      maxSpawnedZombies: 64
      maxSpawnedAnimals: 50
  admin:
    webDashboardEnabled: true
    webDashboardPort: 8080
    telnetEnabled: true
    telnetPort: 8081
    telnetPasswordSecret: "sdtd-telnet"

# Backups - enabled (RWG creates GeneratedWorlds directory)
backups:
  enabled: true
  frequency: 30
  maxBackups: 48

# InitContainer for zero-touch restore from NFS backup
# Only runs on first boot when PVC is empty
extraInitContainers:
  - name: restore-if-empty
    image: busybox:1.36
    command:
      - sh
      - -c
      - |
        if [ ! -f /gamefiles/.restored ]; then
          echo "First boot detected - restoring from latest backup..."

          # Check for 7DTD backups on NFS
          if [ -f /nfs/sdtd/backups/latest.tar.gz ]; then
            echo "Restoring save data..."
            tar -xzf /nfs/sdtd/backups/latest.tar.gz -C /gamefiles/
          fi

          if [ -f /nfs/sdtd/backups/latest-world.tar.gz ]; then
            echo "Restoring world terrain..."
            tar -xzf /nfs/sdtd/backups/latest-world.tar.gz -C /gamefiles/
          fi

          # Mark as restored
          touch /gamefiles/.restored
          echo "Restore complete!"
        else
          echo "PVC already initialized - skipping restore"
        fi
    volumeMounts:
      - name: gamefiles
        mountPath: /gamefiles
      - name: nfs
        mountPath: /nfs
        readOnly: true
    securityContext:
      runAsUser: 0  # May need root for tar extraction

# NFS volume for restore initContainer
extraVolumes:
  - name: nfs
    hostPath:
      path: /mnt/k3s-nfs
      type: Directory

# Soft anti-affinity to spread game servers across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - factorio-server-charts  # Don't co-locate with Factorio
          topologyKey: kubernetes.io/hostname
