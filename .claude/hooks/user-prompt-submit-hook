#!/bin/bash
# Homelab Proxmox Workflow Enforcement Hook
# Runs after each user prompt to ensure workflow compliance

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track if we found any issues
ISSUES_FOUND=0

echo ""
echo "ğŸ” Workflow Compliance Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check 1: Uncommitted changes
if [[ $(git status --porcelain 2>/dev/null) ]]; then
    echo -e "${YELLOW}âš ï¸  Uncommitted changes detected${NC}"
    echo "   Files changed:"
    git status --short | head -5
    if [[ $(git status --short | wc -l) -gt 5 ]]; then
        echo "   ... and $(($(git status --short | wc -l) - 5)) more"
    fi
    echo "   ğŸ’¡ Remember to commit after completing tasks!"
    ISSUES_FOUND=1
    echo ""
fi

# Check 2: Prompt logging (check if MOST RECENT entry is recent)
if [[ -f "logs/prompts.log" ]]; then
    # Get the most recent timestamp from the log
    LAST_TIMESTAMP=$(grep -E '^\[20[0-9]{2}-[0-9]{2}-[0-9]{2}' logs/prompts.log | tail -1 | grep -oE '[0-9]{2}:[0-9]{2}:[0-9]{2}' || echo "")

    # Check for shell syntax that won't evaluate
    if grep -q '\$(date' logs/prompts.log 2>/dev/null; then
        echo -e "${RED}âŒ Prompt log contains unevaluated shell syntax${NC}"
        echo "   Found: \$(date +%H:%M:%S) or similar"
        echo "   ğŸ’¡ Use actual timestamps, not shell variables!"
        ISSUES_FOUND=1
        echo ""
    fi

    # Check if most recent entry is within last 2 minutes
    if [[ -n "$LAST_TIMESTAMP" ]]; then
        CURRENT_TIME=$(date +%s)
        LAST_TIME=$(date -j -f "%H:%M:%S" "$LAST_TIMESTAMP" +%s 2>/dev/null || echo "0")
        TIME_DIFF=$((CURRENT_TIME - LAST_TIME))

        # If last log entry is older than 2 minutes, warn
        if [[ $TIME_DIFF -gt 120 ]]; then
            echo -e "${YELLOW}âš ï¸  Last prompt log entry is $((TIME_DIFF / 60)) minutes old${NC}"
            echo "   ğŸ’¡ Log THIS user prompt to logs/prompts.log NOW"
            ISSUES_FOUND=1
            echo ""
        fi
    else
        echo -e "${YELLOW}âš ï¸  Could not find recent timestamp in prompt log${NC}"
        echo "   ğŸ’¡ Ensure logging after EVERY user prompt"
        ISSUES_FOUND=1
        echo ""
    fi
else
    echo -e "${RED}âŒ logs/prompts.log not found${NC}"
    echo "   ğŸ’¡ Create logs/prompts.log to track interactions"
    ISSUES_FOUND=1
    echo ""
fi

# Check 3: CLAUDE.md Last Updated date
if [[ -f "CLAUDE.md" ]]; then
    LAST_UPDATED=$(grep "Last Updated:" CLAUDE.md | head -1 | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
    if [[ -n "$LAST_UPDATED" ]]; then
        DAYS_OLD=$(( ($(date +%s) - $(date -j -f "%Y-%m-%d" "$LAST_UPDATED" +%s 2>/dev/null || echo 0)) / 86400 ))
        if [[ $DAYS_OLD -gt 1 ]]; then
            echo -e "${YELLOW}âš ï¸  CLAUDE.md Last Updated: $LAST_UPDATED ($DAYS_OLD days old)${NC}"
            echo "   ğŸ’¡ Update 'Last Updated' when plan changes"
            ISSUES_FOUND=1
            echo ""
        fi
    fi
fi

# Check 4: Look for potential hardcoded values in recent changes
if git diff --cached --quiet 2>/dev/null; then
    : # No staged changes, skip check
else
    if git diff --cached | grep -E '(password|secret|token|api[_-]?key).*=.*["\047][^"\047]{8,}["\047]' >/dev/null 2>&1; then
        echo -e "${RED}âŒ Potential hardcoded secrets in staged changes${NC}"
        echo "   ğŸ’¡ Use environment variables in .envrc instead"
        ISSUES_FOUND=1
        echo ""
    fi
fi

# Summary
if [[ $ISSUES_FOUND -eq 0 ]]; then
    echo -e "${GREEN}âœ… All workflow checks passed${NC}"
else
    echo -e "${YELLOW}ğŸ’¡ Run /validate for detailed compliance check${NC}"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
