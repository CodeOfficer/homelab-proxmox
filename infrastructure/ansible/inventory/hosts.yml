# Ansible Inventory for K3s Cluster
# SSH key: ~/.ssh/id_ed25519 (must match TF_VAR_vm_ssh_keys in .envrc)
#
# HA Configuration: 3-node control plane with embedded etcd
# - k3s-cp-01, k3s-cp-02: General workloads
# - k3s-gpu-01: GPU workloads only (tainted: dedicated=gpu:NoSchedule)
# All 3 nodes run etcd for true HA (survives single node failure)

all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.ssh/id_ed25519
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/id_ed25519'

    # K3s configuration
    k3s_version: v1.33.6+k3s1
    k3s_become: true
    k3s_etcd_datastore: true  # Required for HA with multiple control plane nodes

    # Cluster join configuration
    # Token lookup order:
    #   1. .secrets/k3s-token (auto-saved by 'make ansible-k3s')
    #   2. K3S_TOKEN environment variable
    #   3. Omit (fresh install only - first server generates token)
    # WARNING: For rebuilds, ensure .secrets/k3s-token exists or cluster will split!
    # The Makefile will prompt for confirmation if no token is found.
    # NOTE: Init server selected by xanmanning.k3s role based on inventory order (first host in 'server' group).
    # k3s_registration_address must point to init server IP for joining nodes to connect to :6443.
    k3s_registration_address: 10.20.11.80
    k3s_token: "{{ lookup('file', playbook_dir + '/../../.secrets/k3s-token', errors='ignore') | default(lookup('env', 'K3S_TOKEN'), true) | default(omit) }}"

  children:
    k3s_cluster:
      children:
        server:
          hosts:
            k3s-cp-01:
              ansible_host: 10.20.11.80
              k3s_control_node: true
            k3s-cp-02:
              ansible_host: 10.20.11.81
              k3s_control_node: true
            k3s-gpu-01:
              ansible_host: 10.20.11.85
              k3s_control_node: true
        agent:
          hosts: {}  # All nodes are now servers (3-node HA)
    gpu_nodes:
      hosts:
        k3s-gpu-01:
          ansible_host: 10.20.11.85
    # Single-node groups for targeted playbooks
    k3s_cp_01:
      hosts:
        k3s-cp-01:
          ansible_host: 10.20.11.80
