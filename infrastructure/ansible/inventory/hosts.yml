# Ansible Inventory for K3s Cluster
# SSH key: ~/.ssh/id_ed25519 (must match TF_VAR_vm_ssh_keys in .envrc)

all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.ssh/id_ed25519
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/id_ed25519'

    # K3s configuration
    k3s_version: v1.33.6+k3s1
    k3s_become: true
    k3s_etcd_datastore: true  # Required for HA with multiple control plane nodes
    k3s_skip_validation: true  # Allow 2-node etcd (role requires 3, but K3s works with 2)

    # Cluster join configuration
    # Token is auto-saved to .secrets/k3s-token by 'make ansible-k3s'
    # Falls back to K3S_TOKEN env var, or omits for fresh install (first server generates token)
    k3s_registration_address: 10.20.11.80
    k3s_token: "{{ lookup('file', playbook_dir + '/../../.secrets/k3s-token', errors='ignore') | default(lookup('env', 'K3S_TOKEN'), true) | default(omit) }}"

  children:
    k3s_cluster:
      children:
        server:
          hosts:
            k3s-cp-01:
              ansible_host: 10.20.11.80
              k3s_control_node: true
            k3s-cp-02:
              ansible_host: 10.20.11.81
              k3s_control_node: true
        agent:
          hosts:
            k3s-gpu-01:
              ansible_host: 10.20.11.85
              k3s_control_node: false
    gpu_nodes:
      hosts:
        k3s-gpu-01:
          ansible_host: 10.20.11.85
