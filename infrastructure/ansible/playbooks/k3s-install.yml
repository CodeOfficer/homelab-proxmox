# K3s Cluster Installation Playbook
# Installs K3s on server (control plane) and agent (worker) nodes

- name: Prepare nodes
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for nodes to be ready
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

  tasks:
    # Expand LVM to use full disk (template defaults to 10G LV regardless of disk size)
    - name: Install cloud-guest-utils for growpart
      apt:
        name: cloud-guest-utils
        state: present
        update_cache: true

    - name: Check current root partition size
      command: lsblk -b -n -o SIZE /dev/sda3
      register: sda3_size
      changed_when: false

    - name: Check total disk size
      command: lsblk -b -n -o SIZE /dev/sda
      register: sda_size
      changed_when: false

    # Expand partition (may already be done by cloud-init, rc=1 means NOCHANGE)
    - name: Expand partition if disk is larger than partition
      command: growpart /dev/sda 3
      register: growpart_result
      failed_when: growpart_result.rc not in [0, 1]
      changed_when: growpart_result.rc == 0

    # Always resize PV - cloud-init expands partition but not LVM
    - name: Resize physical volume to fill partition
      command: pvresize /dev/sda3
      register: pvresize_result
      changed_when: "'0 free' not in pvresize_result.stdout"

    # Always try to extend LV to use free space (rc=5 means already at max)
    - name: Extend logical volume to use all free space
      command: lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv
      register: lvextend_result
      failed_when: lvextend_result.rc not in [0, 5]
      changed_when: lvextend_result.rc == 0

    # Resize filesystem if LV was extended
    - name: Resize filesystem to fill logical volume
      command: resize2fs /dev/ubuntu-vg/ubuntu-lv
      when: lvextend_result.rc == 0

- name: Install K3s Cluster
  hosts: all
  become: true
  gather_facts: true

  roles:
    - role: xanmanning.k3s

- name: Configure GPU node
  hosts: gpu_nodes
  become: true
  tasks:
    # Step 1: Install NVIDIA GPU drivers
    - name: Install NVIDIA driver prerequisites
      apt:
        name:
          - ubuntu-drivers-common
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Check if NVIDIA driver is installed
      command: nvidia-smi
      register: nvidia_check
      ignore_errors: true
      changed_when: false

    - name: Auto-install NVIDIA drivers (headless/server)
      command: ubuntu-drivers install --gpgpu
      register: driver_install
      when: nvidia_check.rc != 0

    - name: Install nvidia-utils for nvidia-smi
      apt:
        name: nvidia-utils-570-server
        state: present
      when: nvidia_check.rc != 0

    - name: Reboot after driver install
      reboot:
        reboot_timeout: 300
      when: driver_install is changed

    - name: Wait for system to come back
      wait_for_connection:
        timeout: 300
      when: driver_install is changed

    - name: Verify nvidia-smi works
      command: nvidia-smi
      register: nvidia_smi_verify
      changed_when: false

    # Step 2: Install NVIDIA container toolkit
    - name: Add NVIDIA container toolkit GPG key
      shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
        gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    - name: Add NVIDIA container toolkit repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
        state: present
        filename: nvidia-container-toolkit

    - name: Install NVIDIA container toolkit
      apt:
        name: nvidia-container-toolkit
        state: present
        update_cache: true
      notify: restart k3s agent

    # Step 3: K3s auto-detects NVIDIA runtime - no nvidia-ctk configure needed
    # Just verify it was detected after restart
    - name: Flush handlers to restart K3s
      meta: flush_handlers

    - name: Wait for K3s agent to be ready
      pause:
        seconds: 10

    - name: Verify K3s detected NVIDIA runtime
      shell: grep nvidia /var/lib/rancher/k3s/agent/etc/containerd/config.toml
      register: nvidia_runtime_check
      changed_when: false
      failed_when: false

    - name: Display NVIDIA runtime detection status
      debug:
        msg: "{{ 'NVIDIA runtime detected by K3s' if nvidia_runtime_check.rc == 0 else 'WARNING: NVIDIA runtime not yet detected - may need K3s restart' }}"

  handlers:
    - name: restart k3s agent
      systemd:
        name: k3s
        state: restarted

- name: Label GPU nodes in Kubernetes
  hosts: server[0]
  become: true
  tasks:
    - name: Wait for GPU nodes to join cluster
      command: kubectl get node {{ item }} --no-headers
      register: node_check
      until: node_check.rc == 0
      retries: 30
      delay: 10
      loop: "{{ groups['gpu_nodes'] }}"
      changed_when: false

    - name: Label GPU nodes for nvidia device plugin
      command: kubectl label node {{ item }} nvidia.com/gpu.present=true --overwrite
      loop: "{{ groups['gpu_nodes'] }}"
      changed_when: true
